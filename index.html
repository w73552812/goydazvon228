<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoydaZvon | Video & Unique ID</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.0.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #313338; --card: #2b2d31; --primary: #5865f2; --success: #23a559; --error: #da373c; --text: #dbdee1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .window { background: var(--card); padding: 25px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        h1 { font-size: 24px; margin-bottom: 20px; color: white; font-weight: 800; }
        .label { text-align: left; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #b5bac1; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 3px; border: none; background: #1e1f22; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 3px; color: white; font-weight: 500; cursor: pointer; }
        button:disabled { background: #4e5058; }

        .video-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; max-height: 65vh; overflow-y: auto; }
        .user-container { background: #232428; border-radius: 8px; overflow: hidden; border: 2px solid transparent; }
        .user-container.speaking { border-color: var(--success); }
        .video-player { width: 100%; height: 200px; background: #000; }
        .user-info { padding: 8px; display: flex; align-items: center; justify-content: space-between; }
        .nick { font-weight: 600; font-size: 14px; color: white; }
        
        .controls { display: flex; gap: 8px; margin-top: 20px; background: #1e1f22; padding: 10px; border-radius: 8px; }
        .btn-icon { background: #4e5058; padding: 10px; font-size: 20px; flex: 1; border: none; color: white; cursor: pointer; border-radius: 4px; }
        .btn-icon.active { background: var(--primary); }
        .btn-icon.off { background: var(--error); }
        #error-msg { color: var(--error); font-size: 13px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div id="setup" class="window">
    <h1>GOYDAZVON</h1>
    <div id="error-msg">‚ö†Ô∏è –≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!</div>
    <div class="label">–ö–æ–º–Ω–∞—Ç–∞</div>
    <input type="text" id="roomInput" value="goyda-main">
    <div class="label">–¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫</div>
    <input type="text" id="nameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è...">
    <button id="joinBtn" onclick="join()">–í–û–ô–¢–ò</button>
</div>

<div id="room" class="window" style="display:none; width: 450px;">
    <div class="label" id="roomTitle">–ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</div>
    <div class="video-grid" id="userList">
        <div class="user-container" id="local-user-container">
            <div id="local-player" class="video-player"></div>
            <div class="user-info"><span class="nick" id="local-nick">–í—ã</span></div>
        </div>
    </div>
    <div class="controls">
        <button id="muteBtn" class="btn-icon active" onclick="toggleMute()">üéôÔ∏è</button>
        <button id="videoBtn" class="btn-icon active" onclick="toggleVideo()">üì∑</button>
        <button class="btn-icon off" onclick="location.reload()">‚ùå</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://goydazvon-e4140-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const APP_ID = "0a8621015fe0434698d14bd83b1fde91"; 
    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    
    let localTracks = { videoTrack: null, audioTrack: null };
    let isMuted = false;
    let isVideoOff = false;

    window.onload = () => {
        const saved = localStorage.getItem('goyda_unique_nick');
        if (saved) document.getElementById('nameInput').value = saved;
    };

    function addUserCard(uid, nick) {
        if (document.getElementById(`user-${uid}`)) return;
        const container = document.createElement('div');
        container.id = `user-${uid}`;
        container.className = 'user-container';
        container.innerHTML = `
            <div id="player-${uid}" class="video-player"></div>
            <div class="user-info">
                <span class="nick">${nick}</span>
                <input type="range" min="0" max="100" value="100" id="vol-${uid}" style="width:60px; accent-color:#5865f2">
            </div>
        `;
        document.getElementById('userList').appendChild(container);

        document.getElementById(`vol-${uid}`).oninput = (e) => {
            const user = client.remoteUsers.find(u => u.uid == uid);
            if (user && user.audioTrack) user.audioTrack.setVolume(parseInt(e.target.value));
        };
    }

    async function toggleMute() {
        if (!localTracks.audioTrack) return;
        isMuted = !isMuted;
        await localTracks.audioTrack.setEnabled(!isMuted);
        document.getElementById('muteBtn').innerText = isMuted ? "üîá" : "üéôÔ∏è";
        document.getElementById('muteBtn').className = isMuted ? 'btn-icon off' : 'btn-icon active';
    }

    async function toggleVideo() {
        if (!localTracks.videoTrack) return;
        isVideoOff = !isVideoOff;
        await localTracks.videoTrack.setEnabled(!isVideoOff);
        document.getElementById('videoBtn').innerText = isVideoOff ? "üö´" : "üì∑";
        document.getElementById('videoBtn').className = isVideoOff ? 'btn-icon off' : 'btn-icon active';
    }

    async function join() {
        const room = document.getElementById('roomInput').value.trim();
        const nick = document.getElementById('nameInput').value.trim();
        const btn = document.getElementById('joinBtn');
        
        if (!room || !nick) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
        btn.disabled = true;

        const snapshot = await db.ref(`rooms/${room}/users`).once('value');
        const users = snapshot.val() || {};
        if (Object.values(users).some(u => u.name.toLowerCase() === nick.toLowerCase())) {
            document.getElementById('error-msg').style.display = 'block';
            btn.disabled = false;
            return;
        }

        localStorage.setItem('goyda_unique_nick', nick);
        
        try {
            const uid = await client.join(APP_ID, room, null, null);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('room').style.display = 'block';
            document.getElementById('local-nick').innerText = nick;

            db.ref(`rooms/${room}/users/${uid}`).set({ name: nick });
            db.ref(`rooms/${room}/users/${uid}`).onDisconnect().remove();

            [localTracks.audioTrack, localTracks.videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
            localTracks.videoTrack.play('local-player');
            await client.publish(Object.values(localTracks));

            Object.keys(users).forEach(id => addUserCard(id, users[id].name));

            client.enableAudioVolumeIndicator();
            client.on("volume-indicator", volumes => {
                volumes.forEach(v => {
                    const id = v.uid === uid ? "local-user-container" : `user-${v.uid}`;
                    document.getElementById(id)?.classList.toggle('speaking', v.level > 10);
                });
            });

            client.on("user-published", async (user, mediaType) => {
                await client.subscribe(user, mediaType);
                if (mediaType === "video") {
                    addUserCard(user.uid, "–ó–∞–≥—Ä—É–∑–∫–∞...");
                    user.videoTrack.play(`player-${user.uid}`);
                    db.ref(`rooms/${room}/users/${user.uid}`).once('value', s => {
                        if (s.val()) document.querySelector(`#user-${user.uid} .nick`).innerText = s.val().name;
                    });
                }
                if (mediaType === "audio") user.audioTrack.play();
            });

            client.on("user-left", user => document.getElementById(`user-${user.uid}`)?.remove());
        } catch (e) {
            console.error(e);
            alert("–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
