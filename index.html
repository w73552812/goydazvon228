<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoydaZvon | Unique ID</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.0.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #313338; --card: #2b2d31; --primary: #5865f2; --success: #23a559; --error: #da373c; --text: #dbdee1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .window { background: var(--card); padding: 32px; border-radius: 8px; width: 340px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        h1 { font-size: 24px; margin-bottom: 20px; color: white; font-weight: 800; letter-spacing: 1px; }
        .label { text-align: left; font-size: 12px; font-weight: bold; text-transform: uppercase; color: #b5bac1; margin-bottom: 8px; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 3px; border: none; background: #1e1f22; color: white; box-sizing: border-box; font-size: 16px; }
        input:focus { outline: 2px solid var(--primary); }
        button { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 3px; color: white; font-size: 16px; font-weight: 500; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button:hover { background: #4752c4; }
        button:disabled { background: #4e5058; cursor: not-allowed; }
        .user-list { margin-top: 20px; display: flex; flex-direction: column; gap: 8px; text-align: left; }
        .user-card { background: #232428; padding: 10px; border-radius: 4px; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 4px solid transparent; }
        .user-card.speaking { border-left-color: var(--success); background: #2e3035; }
        .avatar { width: 35px; height: 35px; background: #5865f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; }
        .nick { font-weight: 600; color: white; font-size: 15px; }
        .controls { display: flex; gap: 10px; margin-top: 20px; background: #1e1f22; padding: 10px; border-radius: 8px; }
        .btn-icon { background: transparent; padding: 5px; font-size: 22px; flex: 1; border: none; color: white; cursor: pointer; border-radius: 4px; }
        .btn-icon:hover { background: #35373c; }
        #error-msg { color: var(--error); font-size: 13px; margin-bottom: 15px; display: none; background: rgba(218, 55, 60, 0.1); padding: 8px; border-radius: 4px; text-align: left; }
    </style>
</head>
<body>

<div id="setup" class="window">
    <h1>GOYDAZVON</h1>
    <div id="error-msg">‚ö†Ô∏è –≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ –≤ —Å–µ—Ç–∏!</div>
    <div class="label">–ö–æ–º–Ω–∞—Ç–∞</div>
    <input type="text" id="roomInput" value="goyda-main">
    <div class="label">–¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω</div>
    <input type="text" id="nameInput" placeholder="–ù–∞–ø—Ä: Maxim">
    <button id="joinBtn" onclick="join()">–í–û–ô–¢–ò</button>
</div>

<div id="room" class="window" style="display:none; width: 380px;">
    <div class="label" id="roomTitle">–ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</div>
    <div class="user-list" id="userList">
        <div class="user-card" id="local-user">
            <div class="avatar" id="local-avatar">?</div>
            <div class="nick" id="local-nick">–í—ã</div>
        </div>
    </div>
    <div class="controls">
        <button id="muteBtn" class="btn-icon" onclick="toggleMute()">üéôÔ∏è</button>
        <button class="btn-icon" onclick="location.reload()">‚ùå</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://goydazvon-e4140-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const APP_ID = "0a8621015fe0434698d14bd83b1fde91"; 
    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localTracks = { audioTrack: null };
    let isMuted = false;

    window.onload = () => {
        const saved = localStorage.getItem('goyda_unique_nick');
        if (saved) document.getElementById('nameInput').value = saved;
    };

    function addUserCard(uid, nick) {
        if (document.getElementById(`user-${uid}`)) return;
        const card = document.createElement('div');
        card.id = `user-${uid}`;
        card.className = 'user-card';
        card.innerHTML = `
            <div class="avatar" style="background: #e67e22">${nick[0].toUpperCase()}</div>
            <div class="nick">${nick}</div>
        `;
        document.getElementById('userList').appendChild(card);
    }

    async function toggleMute() {
        if (!localTracks.audioTrack) return;
        isMuted = !isMuted;
        await localTracks.audioTrack.setEnabled(!isMuted);
        document.getElementById('muteBtn').innerText = isMuted ? "üîá" : "üéôÔ∏è";
        document.getElementById('local-user').style.opacity = isMuted ? "0.4" : "1";
    }

    async function join() {
        const room = document.getElementById('roomInput').value.trim();
        const nick = document.getElementById('nameInput').value.trim();
        const btn = document.getElementById('joinBtn');
        const errorEl = document.getElementById('error-msg');

        if (!room || !nick) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
        btn.disabled = true;
        errorEl.style.display = 'none';

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
        const snapshot = await db.ref(`rooms/${room}/users`).once('value');
        const users = snapshot.val() || {};
        const taken = Object.values(users).some(u => u.name.toLowerCase() === nick.toLowerCase());

        if (taken) {
            errorEl.style.display = 'block';
            btn.disabled = false;
            return;
        }

        // 2. –í—Ö–æ–¥
        localStorage.setItem('goyda_unique_nick', nick);
        try {
            const uid = await client.join(APP_ID, room, null, null);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('room').style.display = 'block';
            document.getElementById('roomTitle').innerText = "# " + room;
            document.getElementById('local-nick').innerText = nick;
            document.getElementById('local-avatar').innerText = nick[0].toUpperCase();

            db.ref(`rooms/${room}/users/${uid}`).set({ name: nick });
            db.ref(`rooms/${room}/users/${uid}`).onDisconnect().remove();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –≤ –∫–∞–Ω–∞–ª–µ
            Object.keys(users).forEach(id => addUserCard(id, users[id].name));

            localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await client.publish([localTracks.audioTrack]);

            client.enableAudioVolumeIndicator();
            client.on("volume-indicator", volumes => {
                volumes.forEach(v => {
                    const id = v.uid === uid ? "local-user" : `user-${v.uid}`;
                    document.getElementById(id)?.classList.toggle('speaking', v.level > 10);
                });
            });

            client.on("user-published", async (user, mediaType) => {
                await client.subscribe(user, mediaType);
                if (mediaType === "audio") {
                    user.audioTrack.play();
                    setTimeout(() => {
                        db.ref(`rooms/${room}/users/${user.uid}`).once('value', s => {
                            if (s.val()) addUserCard(user.uid, s.val().name);
                        });
                    }, 1500);
                }
            });

            client.on("user-left", user => {
                document.getElementById(`user-${user.uid}`)?.remove();
            });
        } catch (e) {
            btn.disabled = false;
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
        }
    }
</script>
</body>
</html>
