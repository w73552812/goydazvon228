<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoydaZvon | Advanced Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0f172a; --primary: #ef4444; --success: #22c55e; --text: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .window { background: #1e293b; padding: 30px; border-radius: 24px; width: 350px; text-align: center; border: 1px solid #334155; }
        h1 { color: var(--primary); letter-spacing: 2px; }
        input { width: 100%; padding: 14px; margin: 15px 0; border-radius: 12px; border: 2px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .user-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .user-card { background: #0f172a; padding: 15px; border-radius: 15px; border: 2px solid transparent; }
        .user-card.active { border-color: var(--success); }
    </style>
</head>
<body>

<div id="setup" class="window">
    <h1>GOYDAZVON</h1>
    <input type="text" id="roomName" placeholder="ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð°" value="goyda1">
    <button onclick="initCall()">Ð’ÐžÐ™Ð¢Ð˜ Ð’ Ð¡Ð•Ð¢Ð¬</button>
</div>

<div id="room" class="window" style="display:none">
    <h2 id="title"></h2>
    <div class="user-grid" id="userList">
        <div class="user-card" id="my-card">ðŸ‘¤<br>Ð’Ð«</div>
    </div>
    <button onclick="location.reload()" style="margin-top:20px; background:#475569">Ð’Ð«Ð™Ð¢Ð˜</button>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://goydazvon-e4140-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = Math.random().toString(36).substr(2, 9);
    let localStream;
    let peers = {};

    async function initCall() {
        const room = document.getElementById('roomName').value;
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            document.getElementById('setup').style.display = 'none';
            document.getElementById('room').style.display = 'block';
            document.getElementById('title').innerText = "# " + room;

            const roomRef = db.ref('rooms/' + room);

            // Ð¡Ð¾Ð¾Ð±Ñ‰Ð°ÐµÐ¼ Ð²ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð·Ð°ÑˆÐ»Ð¸
            roomRef.child(myId).set({ active: true });
            roomRef.child(myId).onDisconnect().remove();

            // Ð¡Ð»ÑƒÑˆÐ°ÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
            roomRef.on('child_added', snapshot => {
                const userId = snapshot.key;
                if (userId !== myId) {
                    initPeer(userId, room, true); // ÐœÑ‹ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (initiator)
                }
            });

            // Ð¡Ð»ÑƒÑˆÐ°ÐµÐ¼ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹ (Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹)
            db.ref('signals/' + myId).on('child_added', snapshot => {
                const data = snapshot.val();
                if (peers[data.from]) {
                    peers[data.from].signal(data.signal);
                } else {
                    // Ð•ÑÐ»Ð¸ Ð½Ð°Ð¼ Ð¿Ñ€Ð¸ÑˆÐµÐ» ÑÐ¸Ð³Ð½Ð°Ð» Ð¾Ñ‚ Ñ‚Ð¾Ð³Ð¾, ÐºÐ¾Ð³Ð¾ Ð¼Ñ‹ ÐµÑ‰Ðµ Ð½Ðµ Ð·Ð½Ð°ÐµÐ¼ â€” ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¸Ñ€Ð° (Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€)
                    const p = initPeer(data.from, room, false);
                    p.signal(data.signal);
                }
                snapshot.ref.remove();
            });

        } catch (e) { alert("ÐœÐ¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½!"); }
    }

    function initPeer(userId, room, initiator) {
        if (peers[userId]) return peers[userId];

        const p = new SimplePeer({
            initiator: initiator,
            stream: localStream,
            trickle: false,
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
        });

        p.on('signal', data => {
            // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð°Ñˆ ÑÐ¸Ð³Ð½Ð°Ð» Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ Ñ‡ÐµÑ€ÐµÐ· Firebase
            db.ref('signals/' + userId).push({
                from: myId,
                signal: data
            });
        });

        p.on('stream', stream => {
            if (!document.getElementById('v-' + userId)) {
                const audio = new Audio();
                audio.id = 'v-' + userId;
                audio.srcObject = stream;
                audio.play();
                
                const card = document.createElement('div');
                card.className = 'user-card active';
                card.id = 'c-' + userId;
                card.innerHTML = "ðŸ“¢<br>" + userId.substr(0, 4);
                document.getElementById('userList').appendChild(card);
            }
        });

        p.on('close', () => removeUser(userId));
        p.on('error', err => console.error('Peer error:', err));

        peers[userId] = p;
        return p;
    }

    function removeUser(id) {
        document.getElementById('c-' + id)?.remove();
        document.getElementById('v-' + id)?.remove();
        delete peers[id];
    }
</script>
</body>
</html>
