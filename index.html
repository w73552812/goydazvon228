<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoydaZvon | Voice & Files</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #ef4444;
            --success: #22c55e;
            --text: #f1f5f9;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .window {
            background: var(--card);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h1 { color: var(--primary); letter-spacing: 2px; text-transform: uppercase; margin-top: 0; }
        
        input {
            width: 100%;
            padding: 14px;
            margin: 20px 0;
            border-radius: 12px;
            border: 2px solid #334155;
            background: #0f172a;
            color: white;
            box-sizing: border-box;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            color: white;
        }

        .btn-primary { background: var(--primary); }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .user-card {
            background: #0f172a;
            padding: 15px;
            border-radius: 18px;
            border: 3px solid transparent;
            transition: 0.2s;
        }

        .user-card.speaking {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-tool { background: #475569; flex: 1; font-size: 1.2rem; }
        .btn-mute.active { background: var(--primary); }

        #error-log { color: #fca5a5; font-size: 0.8rem; margin-top: 10px; display: none; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        
        .file-link {
            display: block;
            background: var(--success);
            color: white;
            text-decoration: none;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="window" id="setup-ui">
    <h1>GOYDAZVON</h1>
    <input type="text" id="roomInput" placeholder="–ö–æ–º–Ω–∞—Ç–∞" value="goyda1">
    <button class="btn btn-primary" onclick="startGoyda()">–í–û–ô–¢–ò –í –ì–û–õ–û–°</button>
    <div id="error-log"></div>
</div>

<div class="window" id="room-ui" style="display:none">
    <h2 id="roomTitle" style="margin: 0;"></h2>
    <div id="userList" class="user-grid">
        <div class="user-card" id="my-card">
            <div style="font-size:2rem">üë§</div>
            <div style="font-size:0.8rem">–í–´</div>
        </div>
    </div>
    
    <div class="controls">
        <button id="mute-btn" class="btn btn-tool" onclick="toggleMute()">üéôÔ∏è</button>
        <label class="btn btn-tool" style="cursor:pointer">
            üìé <input type="file" id="fileInput" onchange="sendFile()" style="display:none">
        </label>
        <button class="btn btn-tool" style="background:#334155" onclick="location.reload()">‚ùå</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        databaseURL: "https://goydazvon-e4140-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let localStream, peer, audioContext, isMuted = false;
    const activeCalls = {};

    function logError(msg) {
        const el = document.getElementById('error-log');
        el.style.display = 'block';
        el.innerText = msg;
    }

    async function startGoyda() {
        const roomName = document.getElementById('roomInput').value.trim();
        if(!roomName) return;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            return logError("–û—à–∏–±–∫–∞: –ù—É–∂–µ–Ω HTTPS –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞!");
        }

        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch (e) {
            return logError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ù–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ—á–µ–∫ –≤ —Å—Ç—Ä–æ–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø.");
        }

        peer = new Peer();

        peer.on('open', (myId) => {
            document.getElementById('setup-ui').style.display = 'none';
            document.getElementById('room-ui').style.display = 'block';
            document.getElementById('roomTitle').innerText = "#" + roomName;

            const roomRef = db.ref('rooms/' + roomName);
            roomRef.child(myId).set(true);
            roomRef.child(myId).onDisconnect().remove();

            roomRef.on('child_added', (snap) => {
                const otherId = snap.key;
                if (otherId !== myId && !activeCalls[otherId]) {
                    connectToUser(otherId);
                }
            });
            setupVoiceIndicator(localStream, 'my-card');
        });

        peer.on('call', (call) => {
            call.answer(localStream);
            handleStream(call);
        });

        // –°–ª—É—à–∞–µ–º —Ñ–∞–π–ª—ã
        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                if (data.file) {
                    const blob = new Blob([data.file], { type: data.fileType });
                    const url = URL.createObjectURL(blob);
                    const card = document.getElementById('card-' + conn.peer) || document.getElementById('my-card');
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = data.fileName;
                    link.className = 'file-link';
                    link.innerText = "üìÅ " + data.fileName;
                    card.appendChild(link);
                }
            });
        });
    }

    function connectToUser(userId) {
        const call = peer.call(userId, localStream);
        handleStream(call);
    }

    function handleStream(call) {
        activeCalls[call.peer] = call;
        call.on('stream', (stream) => {
            if (!document.getElementById('audio-' + call.peer)) {
                const audio = new Audio();
                audio.id = 'audio-' + call.peer;
                audio.srcObject = stream;
                audio.play().catch(() => logError("–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫"));

                const card = document.createElement('div');
                card.id = 'card-' + call.peer;
                card.className = 'user-card';
                card.innerHTML = `<div style="font-size:2rem">üì¢</div><div style="font-size:0.7rem">${call.peer.substring(0,4)}</div>`;
                document.getElementById('userList').appendChild(card);
                setupVoiceIndicator(stream, card.id);
            }
        });
    }

    function setupVoiceIndicator(stream, cardId) {
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        const data = new Uint8Array(analyser.frequencyBinCount);

        function check() {
            if (!document.getElementById(cardId)) return;
            analyser.getByteFrequencyData(data);
            const avg = data.reduce((a, b) => a + b) / data.length;
            const card = document.getElementById(cardId);
            if (avg > 15) card.classList.add('speaking');
            else card.classList.remove('speaking');
            requestAnimationFrame(check);
        }
        check();
    }

    function toggleMute() {
        isMuted = !isMuted;
        localStream.getAudioTracks()[0].enabled = !isMuted;
        document.getElementById('mute-btn').classList.toggle('active', isMuted);
    }

    function sendFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        Object.keys(activeCalls).forEach(id => {
            const conn = peer.connect(id);
            conn.on('open', () => conn.send({ file, fileName: file.name, fileType: file.type }));
        });
        alert("–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º!");
    }
</script>
</body>
</html>
