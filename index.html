<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoydaZvon | Voice & Files</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #ef4444;
            --success: #22c55e;
            --text: #f1f5f9;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .window {
            background: var(--card);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h1 { color: var(--primary); letter-spacing: 2px; text-transform: uppercase; margin-top: 0; }
        
        input {
            width: 100%;
            padding: 14px;
            margin: 20px 0;
            border-radius: 12px;
            border: 2px solid #334155;
            background: #0f172a;
            color: white;
            box-sizing: border-box;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            color: white;
        }

        .btn-primary { background: var(--primary); }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .user-card {
            background: #0f172a;
            padding: 15px;
            border-radius: 18px;
            border: 3px solid transparent;
            transition: 0.2s;
        }

        .user-card.speaking {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-tool { background: #475569; flex: 1; font-size: 1.2rem; }
        .btn-mute.active { background: var(--primary); }

        #error-log { color: #fca5a5; font-size: 0.8rem; margin-top: 10px; display: none; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        
        .file-link {
            display: block;
            background: var(--success);
            color: white;
            text-decoration: none;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="window" id="setup-ui">
    <h1>GOYDAZVON</h1>
    <input type="text" id="roomInput" placeholder="–ö–æ–º–Ω–∞—Ç–∞" value="goyda1">
    <button class="btn btn-primary" onclick="startGoyda()">–í–û–ô–¢–ò –í –ì–û–õ–û–°</button>
    <div id="error-log"></div>
</div>

<div class="window" id="room-ui" style="display:none">
    <h2 id="roomTitle" style="margin: 0;"></h2>
    <div id="userList" class="user-grid">
        <div class="user-card" id="my-card">
            <div style="font-size:2rem">üë§</div>
            <div style="font-size:0.8rem">–í–´</div>
        </div>
    </div>
    
    <div class="controls">
        <button id="mute-btn" class="btn btn-tool" onclick="toggleMute()">üéôÔ∏è</button>
        <label class="btn btn-tool" style="cursor:pointer">
            üìé <input type="file" id="fileInput" onchange="sendFile()" style="display:none">
        </label>
        <button class="btn btn-tool" style="background:#334155" onclick="location.reload()">‚ùå</button>
    </div>
</div>

<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    const firebaseConfig = {
        databaseURL: "https://goydazvon-e4140-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    } catch (e) {
        console.error("Firebase init error:", e);
    }
    
    const db = firebase.database();
    let localStream, peer, audioContext, isMuted = false;
    const activeCalls = {};

    async function startGoyda() {
        const btn = document.querySelector('.btn-primary');
        const roomName = document.getElementById('roomInput').value.trim();
        
        if(!roomName) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã!");

        // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
        btn.innerText = "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...";
        btn.disabled = true;

        try {
            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–≤—É–∫–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞ (–≤–∞–∂–Ω–æ –¥–ª—è Chrome/Safari)
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            // –ó–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch (e) {
            btn.innerText = "–û–®–ò–ë–ö–ê";
            btn.disabled = false;
            alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
            return;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ PeerJS —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        peer = new Peer({
            debug: 2 // –í—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        });

        peer.on('open', (myId) => {
            console.log("–ú–æ–π ID –≤ —Å–µ—Ç–∏:", myId);
            document.getElementById('setup-ui').style.display = 'none';
            document.getElementById('room-ui').style.display = 'block';
            document.getElementById('roomTitle').innerText = "#" + roomName;

            const roomRef = db.ref('rooms/' + roomName);
            roomRef.child(myId).set(true);
            roomRef.child(myId).onDisconnect().remove();

            roomRef.on('child_added', (snap) => {
                const otherId = snap.key;
                if (otherId !== myId && !activeCalls[otherId]) {
                    connectToUser(otherId);
                }
            });
            setupVoiceIndicator(localStream, 'my-card');
        });

        peer.on('call', (call) => {
            call.answer(localStream);
            handleStream(call);
        });

        peer.on('error', (err) => {
            console.error("PeerJS error:", err);
            btn.innerText = "–û–®–ò–ë–ö–ê –°–ï–¢–ò";
            btn.disabled = false;
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.type);
        });
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (connectToUser, handleStream, setupVoiceIndicator, toggleMute) 
    // –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
</script>
</body>
</html>

