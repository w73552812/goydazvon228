const firebaseConfig = { databaseURL: "https://goydazvon-e4140-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫ –Ω–µ–º—É –º–µ—Ç–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    let myId = (navigator.userAgent.match(/iPhone|Android/i) ? 'mob-' : 'pc-') + Math.random().toString(36).substr(2, 5);
    let localStream;
    let peers = {};

    async function initCall() {
        const room = document.getElementById('roomName').value;
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            document.getElementById('setup').style.display = 'none';
            document.getElementById('room').style.display = 'block';
            document.getElementById('title').innerText = "# " + room;

            const roomRef = db.ref('rooms/' + room);
            const signalRef = db.ref('signals/' + myId);

            // 1. –û—á–∏—â–∞–µ–º —Å–≤–æ–∏ —Å—Ç–∞—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º
            await signalRef.remove();

            // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–µ–±—è –≤ –∫–æ–º–Ω–∞—Ç–µ
            roomRef.child(myId).set(true);
            roomRef.child(myId).onDisconnect().remove();

            // 3. –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –ó–ê–•–û–î–ò–¢ (child_added)
            roomRef.on('child_added', snapshot => {
                const userId = snapshot.key;
                // –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ç–æ—Ç, —á–µ–π ID "–º–µ–Ω—å—à–µ" –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç—Ä—é–∫ WebRTC)
                if (userId !== myId && !peers[userId]) {
                    const isInitiator = myId < userId; 
                    initPeer(userId, room, isInitiator);
                }
            });

            // 4. –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ —Å–∏–≥–Ω–∞–ª—ã
            signalRef.on('child_added', snapshot => {
                const data = snapshot.val();
                if (peers[data.from]) {
                    peers[data.from].signal(data.signal);
                } else {
                    // –ï—Å–ª–∏ –ø–∏—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ (–Ω–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä, —Ç–∞–∫ –∫–∞–∫ –Ω–∞–º –ø—Ä–∏—Å–ª–∞–ª–∏ —Å–∏–≥–Ω–∞–ª)
                    const p = initPeer(data.from, room, false);
                    p.signal(data.signal);
                }
                snapshot.ref.remove(); // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª
            });

        } catch (e) { alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + e.message); }
    }

    function initPeer(userId, room, initiator) {
        console.log(`–°–æ–∑–¥–∞—é –ø–∏—Ä —Å ${userId}. –Ø –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${initiator}`);
        
        const p = new SimplePeer({
            initiator: initiator,
            stream: localStream,
            trickle: false, // –î–ª—è Firebase –ª—É—á—à–µ false (–æ–¥–∏–Ω –±–æ–ª—å—à–æ–π –ø–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
        });

        p.on('signal', data => {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –Ω–∞–ø—Ä—è–º—É—é –≤ –≤–µ—Ç–∫—É –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            db.ref('signals/' + userId).push({
                from: myId,
                signal: JSON.stringify(data) // –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            });
        });

        p.on('stream', stream => {
            if (!document.getElementById('v-' + userId)) {
                const audio = new Audio();
                audio.id = 'v-' + userId;
                audio.srcObject = stream;
                audio.play();
                
                const card = document.createElement('div');
                card.className = 'user-card active';
                card.id = 'c-' + userId;
                card.innerHTML = `üì¢<br><small>${userId}</small>`;
                document.getElementById('userList').appendChild(card);
            }
        });

        p.on('close', () => {
            document.getElementById('c-' + userId)?.remove();
            delete peers[userId];
        });

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –ø—Ä–∏—à–µ–ª —Å–∏–≥–Ω–∞–ª –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –ø–∞—Ä—Å–∏–º –µ–≥–æ
        const originalSignal = p.signal;
        p.signal = function(data) {
            if (typeof data === 'string') return originalSignal.call(this, JSON.parse(data));
            return originalSignal.call(this, data);
        };

        peers[userId] = p;
        return p;
    }
